A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/10/2022 19:04:41 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\Práctica 4.obj
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE Práctica 4.asm SET(SMALL) DEBUG PRINT(.\Listings\Práctica 4.lst) OBJECT
                      (.\Objects\Práctica 4.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     
                       2     
                       3     
                       4     
                       5     
                       6     
                       7     
                       8     
                       9     
                      10     
                      11     
                      12     
                      13     
                      14     
                      15     
                      16     
                      17     
                      18     
                      19     
                      20     
                      21     
                      22     
                      23                             
  0094                24                             RS         EQU P1.4                             ; Resister Select d
                             e LCD
  0095                25                             E          EQU P1.5                             ; Enable de LCD
  00A0                26                             LCD    EQU P2                           ; Bus para LCD
  0090                27                             KEYS   EQU P1                           ; Tecla codificada
  0097                28                             ALT    EQU P1.7                         ; Botón ALT
  00D5                29                             ALT_EN EQU 0D5H                         ; ALT activado
  00D1                30                             KYSC   EQU 0D1H                         ; Contador de teclas ingres
                             adas para ALT
  0030                31                             CHARR  EQU 030H                         ; Inicio de arreglo para ca
                             racteres a enviar
                      32                                     
  REG                 33                             CHR_P  EQU R0                           ; Posición de delimitador d
                             e arreglo
  REG                 34                             CH_P_B EQU R1                           ; Posición de arreglo para 
                             bluetooth
  REG                 35                             CCNT   EQU R2                           ; Contador de caracteres pa
                             ra display (max. 32 | 20H)
  REG                 36                             KYSB   EQU R3                           ; Almacenamiento de teclas 
                             presionadas para ALT
                      37     
                      38     
0000                  39                             ORG 0000H                                       
0000 01E0             40                             JMP LCD_INIT
                      41     
                      42     ; ------------------ INTERRUPCIÓN TECLADO ------------------
0003                  43                             ORG 0003H
0003 803B             44                             JMP KEY_IN
                      45     ; ----------------------------------------------------------
                      46     
                      47     
                      48     ; ------------------- INTERRUPCIÓN ALT ---------------------
000B                  49                             ORG 000BH       
000B 018E             50                             JMP ALT_IN
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/10/2022 19:04:41 PAGE     2

                      51     ; ----------------------------------------------------------
                      52     
                      53     
                      54     ; ----------------- INTERRUPCIÓN BLUETOOTH -----------------
0013                  55                             ORG 0013H               
0013 805C             56                             JMP SEND_ND
                      57     ; ----------------------------------------------------------
                      58     
                      59     
                      60     ; -------------------- FLUJO PRINCIPAL ---------------------
0040                  61                             ORG 0040H
                      62     
                      63     ; Para interrupción externa 0 | Detección de tecla o ASCII
0040 E590             64     KEY_IN:         MOV A, KEYS
0042 30D526           65                             JNB ALT_EN, KEY_SGL
                      66                             
0045 20D11A           67                             JB KYSC, ALT_1                          ; Primer caracter
0048 9431             68                             SUBB A, #'1'                            ; Comprobaciones para
004A 6024             69                             JZ KEY_END                                      ; saltar caracteres
004C 2431             70                             ADD A, #'1'                                     ; inválidos según
004E 9438             71                             SUBB A, #'8'                            ; datasheets (1X, 8X, 9X)
0050 601E             72                             JZ KEY_END
0052 2438             73                             ADD A, #'8'
0054 9439             74                             SUBB A, #'9'
0056 6018             75                             JZ KEY_END
0058 2439             76                             ADD A, #'9'
                      77                             
005A C4               78                             SWAP A
005B 54F0             79                             ANL A, #0F0H
005D FB               80                             MOV KYSB, A
005E D2D1             81                             SETB KYSC
0060 800E             82                             SJMP KEY_END
                      83                             
0062 540F             84     ALT_1:          ANL A, #0FH                                     ; Segundo caracter
0064 2B               85                             ADD A, KYSB                                     
0065 C2D1             86                             CLR KYSC
0067 8005             87                             SJMP KEY_SHW                            ; Enviar ASCII
0069 C2D5             88                             CLR ALT_EN
                      89     
                      90                             
006B 540F             91     KEY_SGL:        ANL A, #0FH
006D 93               92                             MOVC A, @A + DPTR                       ; Decodificar caracter
006E 11B2             93     KEY_SHW:        ACALL LCD_CHR                           ; Enviar caracter a LCD
0070 32               94     KEY_END:        RETI
                      95     
                      96     
                      97     ; Para interrupción externa 1 | Envío a bluetooth
0071 7800             98     SEND_ND:        MOV CHR_P, #0
0073 758DFD           99                             MOV TH1, #0FDH
0076 758AFD          100                             MOV TL0, #0FDH                          ; Estándar de 9600 baudios
0079 D28E            101                             SETB TR1
                     102     
007B 3099FD          103     SN_L0:          JNB TI, SN_L0
007E C299            104                             CLR TI
0080 7430            105                             MOV A, #CHARR
0082 28              106                             ADD A, CHR_P
0083 F9              107                             MOV CH_P_B, A
0084 8799            108                             MOV SBUF, @CH_P_B
0086 08              109                             INC CHR_P
0087 09              110                             INC CH_P_B
                     111                             
0088 B910F0          112                             CJNE CH_P_B, #10H, SN_L0
008B C28C            113                             CLR TR0
008D 32              114                             RETI
                     115     
                     116     
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/10/2022 19:04:41 PAGE     3

                     117     ; Para detección de ALT
008E 309702          118     ALT_IN:         JNB ALT, ALT_END
0091 D2D5            119                             SETB ALT_EN
0093 32              120     ALT_END:        RETI
                     121     
                     122     
                     123     ; Subrutina de atraso para dejar libres temporizadores
0094 7F30            124     DELAY:          MOV R7, #30H
0096 7EFF            125     D_0:            MOV R6, #0FFH
0098 DEFE            126     D_1:            DJNZ R6, D_1
009A DFFA            127                             DJNZ R7, D_0
009C 22              128                             RET
                     129     
009D 7401            130     LCD_CLR:        MOV A, #1H                                      ; 20H a cada posición | Lim
                             piar pantalla
009F 11A5            131                             ACALL LCD_CMD
                     132                             
00A1 7480            133     LCD_FL:         MOV A, #80H                                     ; Cursor en primera línea, 
                             primera posición
00A3 11A5            134                             ACALL LCD_CMD
                     135     
                     136     
                     137     ; Subrutina para enviar comandos a LCD
00A5 F5A0            138     LCD_CMD:        MOV LCD, A                                      ; Posicionar comando
00A7 C294            139                             CLR RS                                          ; Modo comando
00A9 D295            140                             SETB E
00AB 1194            141                             ACALL DELAY
00AD C295            142                             CLR E                                           ; Enviar comando
00AF 1194            143                             ACALL DELAY
00B1 22              144                             RET
                     145     
                     146     
                     147     ; Subrutina para enviar datos/caracteres a LCD
00B2 C0E0            148     LCD_CHR:        PUSH 0E0H                                       ; Guardar dato a desplegar
                     149     
00B4 BA2006          150     LCD_ESL:        CJNE CCNT, #20H, LCD_EFL        ; Fin de segunda línea
00B7 119D            151                             ACALL LCD_CLR                           ; Limpiar pantalla
00B9 11A1            152                             ACALL LCD_FL                            ; y resetear a primera posi
                             ción
00BB 7A00            153                             MOV CCNT, #0                            ; Resetear conteo de caract
                             eres
                     154                             
00BD BA1004          155     LCD_EFL:        CJNE CCNT, #10H, LCD_SND        ; Fin de primera línea
00C0 74C0            156                             MOV A, #0C0H                            ; Cursor en segunda línea, 
                             primera posición
00C2 11A5            157                             ACALL LCD_CMD
                     158                             
00C4 D0E0            159     LCD_SND:        POP 0E0H                                        ; Recuperar dato a desplegar
00C6 F5A0            160                             MOV LCD, A                                      ; Posicionar datos
00C8 D294            161                             SETB RS                                         ; Modo datos
00CA D295            162                             SETB E
00CC 1194            163                             ACALL DELAY
00CE C295            164                             CLR E                                           ; Enviar datos
00D0 1194            165                             ACALL DELAY
00D2 11D5            166                             ACALL ARR_SAVE
00D4 22              167                             RET
                     168     
                     169     
                     170     ; Subrutina para almacenar o resetear arreglo de caracteres
                     171     ; Delimitador de arreglo: 10H (por omisión en datasheet)
                     172     ; Inicio de arreglo: 30H
00D5 7430            173     ARR_SAVE:       MOV A, #CHARR
00D7 2A              174                             ADD A, CCNT
00D8 F8              175                             MOV CHR_P, A
00D9 A6A0            176                             MOV @CHR_P, LCD
00DB 0A              177                             INC CCNT
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/10/2022 19:04:41 PAGE     4

00DC 08              178                             INC CHR_P
00DD 7610            179                             MOV @CHR_P, #10H
00DF 22              180                             RET
                     181     
                     182     
                     183     
00E0 1194            184     LCD_INIT:       ACALL DELAY
00E2 1194            185                             ACALL DELAY
                     186                             
00E4 75F004          187                             MOV B, #4H
00E7 7438            188                             MOV A, #38H                                     ; Modo de 8 bits, 2
                              líneas (4 veces)
00E9 11A5            189     LI_0:           ACALL LCD_CMD
00EB 1194            190                             ACALL DELAY
00ED D5F0F9          191                             DJNZ B, LI_0
                     192                             
00F0 740F            193                             MOV A, #0FH                             ; Display, cursor y parpade
                             o encendidos
00F2 11A5            194                             ACALL LCD_CMD
                     195                             
                     196                             ; Se incluye el siguiente comando por aseguramiento pero es omisible
                     197                             ; Incrementar posición, desplazamiento desactivado
00F4 7406            198                             MOV A, #6H
00F6 11A5            199                             ACALL LCD_CMD
                     200                             
00F8 119D            201                             ACALL LCD_CLR                           ; Limpiar LCD
00FA 11A1            202                             ACALL LCD_FL                            ; Cursor inicial
                     203     
                     204     
00FC 900690          205     MAIN:           MOV DPTR, #0A8H * 0AH           ; Posicionar apuntador en tabla de valores
00FF C297            206                             CLR P1.7                                        ; Limpiar para dete
                             cción de ALT
                     207                             
0101 759842          208                             MOV SCON, #42H                          ; Habilitación de comunicac
                             ión serial
                     209                             
                     210                             ; MOV IE, #97H                          ; Interrupciones para seria
                             l, externas y T0
0104 75A887          211                             MOV IE, #87H
0107 758922          212                             MOV TMOD, #22H                          ; T0 modo autorrecarga | T1
                              modo autorrecarga
                     213                             
010A 758C00          214                             MOV TH0, #0
010D 758AFB          215                             MOV TL0, #0FBH                          ; Contar 500 nanosegundos
                     216                             
0110 D28C            217                             SETB TR0
                     218                             
0112 80FE            219                             SJMP $                                          ; Continuar ejecuci
                             ón
                     220                                     
                     221     ; ----------------------------------------------------------
                     222     
                     223     
                     224     
                     225     ; ------------- TABLAS PARA DECODIFICAR TECLAS -------------
                     226     
0690                 227                             ORG 0690H
                     228                             
0690 31323341        229                             DB      '1', '2', '3', 'A'
0694 34353642        230                             DB      '4', '5', '6', 'B'
0698 37383943        231                             DB      '7', '8', '9', 'C'
069C 45304644        232                             DB      'E', '0', 'F', 'D'
                     233     
                     234     ; ----------------------------------------------------------
                     235     
                     236                             END
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/10/2022 19:04:41 PAGE     5

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

ALT. . . . . . . .  B ADDR   0090H.7 A   
ALT_1. . . . . . .  C ADDR   0062H   A   
ALT_EN . . . . . .  N NUMB   00D5H   A   
ALT_END. . . . . .  C ADDR   0093H   A   
ALT_IN . . . . . .  C ADDR   008EH   A   
ARR_SAVE . . . . .  C ADDR   00D5H   A   
B. . . . . . . . .  D ADDR   00F0H   A   
CCNT . . . . . . .    REG    R2          
CHARR. . . . . . .  N NUMB   0030H   A   
CHR_P. . . . . . .    REG    R0          
CH_P_B . . . . . .    REG    R1          
DELAY. . . . . . .  C ADDR   0094H   A   
D_0. . . . . . . .  C ADDR   0096H   A   
D_1. . . . . . . .  C ADDR   0098H   A   
E. . . . . . . . .  B ADDR   0090H.5 A   
IE . . . . . . . .  D ADDR   00A8H   A   
KEYS . . . . . . .  D ADDR   0090H   A   
KEY_END. . . . . .  C ADDR   0070H   A   
KEY_IN . . . . . .  C ADDR   0040H   A   
KEY_SGL. . . . . .  C ADDR   006BH   A   
KEY_SHW. . . . . .  C ADDR   006EH   A   
KYSB . . . . . . .    REG    R3          
KYSC . . . . . . .  N NUMB   00D1H   A   
LCD. . . . . . . .  D ADDR   00A0H   A   
LCD_CHR. . . . . .  C ADDR   00B2H   A   
LCD_CLR. . . . . .  C ADDR   009DH   A   
LCD_CMD. . . . . .  C ADDR   00A5H   A   
LCD_EFL. . . . . .  C ADDR   00BDH   A   
LCD_ESL. . . . . .  C ADDR   00B4H   A   
LCD_FL . . . . . .  C ADDR   00A1H   A   
LCD_INIT . . . . .  C ADDR   00E0H   A   
LCD_SND. . . . . .  C ADDR   00C4H   A   
LI_0 . . . . . . .  C ADDR   00E9H   A   
MAIN . . . . . . .  C ADDR   00FCH   A   
P1 . . . . . . . .  D ADDR   0090H   A   
P2 . . . . . . . .  D ADDR   00A0H   A   
RS . . . . . . . .  B ADDR   0090H.4 A   
SBUF . . . . . . .  D ADDR   0099H   A   
SCON . . . . . . .  D ADDR   0098H   A   
SEND_ND. . . . . .  C ADDR   0071H   A   
SN_L0. . . . . . .  C ADDR   007BH   A   
TH0. . . . . . . .  D ADDR   008CH   A   
TH1. . . . . . . .  D ADDR   008DH   A   
TI . . . . . . . .  B ADDR   0098H.1 A   
TL0. . . . . . . .  D ADDR   008AH   A   
TMOD . . . . . . .  D ADDR   0089H   A   
TR0. . . . . . . .  B ADDR   0088H.4 A   
TR1. . . . . . . .  B ADDR   0088H.6 A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
