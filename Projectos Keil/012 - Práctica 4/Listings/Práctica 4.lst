A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 12:18:47 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\Práctica 4.obj
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE Práctica 4.asm SET(SMALL) DEBUG PRINT(.\Listings\Práctica 4.lst) OBJECT
                      (.\Objects\Práctica 4.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     
                       2     
                       3     
                       4     
                       5     
                       6     
                       7     
                       8     
                       9     
                      10     
                      11     
                      12     
                      13     
                      14     
                      15     
                      16     
                      17     
                      18     
                      19     
                      20     
                      21     
                      22     
                      23                             
  0094                24                             RS         EQU P1.4                             ; Resister Select d
                             e LCD
  0095                25                             E          EQU P1.5                             ; Enable de LCD
  00A0                26                             LCD    EQU P2                           ; Bus para LCD
  0090                27                             KEYS   EQU P1                           ; Tecla codificada
  0097                28                             ALT    EQU P1.7                         ; Botón ALT
  00D5                29                             ALT_EN EQU 0D5H                         ; ALT activado
  00D1                30                             KYSC   EQU 0D1H                         ; Contador de teclas ingres
                             adas para ALT
  0030                31                             CHARR  EQU 030H                         ; Inicio de arreglo para ca
                             racteres a enviar
                      32                                     
  REG                 33                             CHR_P  EQU R0                           ; Posición de delimitador d
                             e arreglo
  REG                 34                             CH_P_B EQU R1                           ; Posición de arreglo para 
                             bluetooth
  REG                 35                             CHR_S  EQU R2                           ; Tamaño de arreglo
  REG                 36                             CCNT   EQU R3                           ; Contador de caracteres pa
                             ra display (max. 32 | 20H)
  REG                 37                             KYSB   EQU R4                           ; Almacenamiento de teclas 
                             presionadas para ALT
                      38     
                      39     
0000                  40                             ORG 0000H                                       
0000 01EB             41                             JMP LCD_INIT
                      42     
                      43     ; ------------------ INTERRUPCIÓN TECLADO ------------------
0003                  44                             ORG 0003H
0003 803B             45                             JMP KEY_IN
                      46     ; ----------------------------------------------------------
                      47     
                      48     
                      49     ; ------------------- INTERRUPCIÓN ALT ---------------------
000B                  50                             ORG 000BH       
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 12:18:47 PAGE     2

000B 0199             51                             JMP ALT_IN
                      52     ; ----------------------------------------------------------
                      53     
                      54     
                      55     ; ----------------- INTERRUPCIÓN BLUETOOTH -----------------
0013                  56                             ORG 0013H               
0013 8061             57                             JMP SEND_ND
                      58     ; ----------------------------------------------------------
                      59     
                      60     
                      61     ; -------------------- FLUJO PRINCIPAL ---------------------
0040                  62                             ORG 0040H
                      63     
                      64     ; Para interrupción externa 0 | Detección de tecla o ASCII
0040 119F             65     KEY_IN:         ACALL DELAY
0042 119F             66                             ACALL DELAY
0044 119F             67                             ACALL DELAY
0046 119F             68                             ACALL DELAY
0048 E590             69                             MOV A, KEYS
004A F4               70                             CPL A
                      71                             
004B 30D502           72                             JNB ALT_EN, KEY_SGL
004E 800C             73                             SJMP KEY_ALT            
                      74                             
0050 540F             75     KEY_SGL:        ANL A, #0FH
0052 93               76                             MOVC A, @A + DPTR                       ; Decodificar caracter
0053 11BD             77     KEY_SHW:        ACALL LCD_CHR                           ; Enviar caracter a LCD
0055 119F             78     KEY_END:        ACALL DELAY
0057 119F             79                             ACALL DELAY
0059 119F             80                             ACALL DELAY
005B 32               81                             RETI
                      82     
005C 20D108           83     KEY_ALT:        JB KYSC, ALT_1                          ;  Primer caracter
                      84                                                     
005F 1170             85                             ACALL SND_DT                            ; Posicionar primera mitad 
                             del ASCII
0061 C4               86                             SWAP A
0062 FC               87                             MOV KYSB, A
0063 D2D1             88                             SETB KYSC                                       ; Se indica la pres
                             encia del primer nibble
0065 80EE             89                             SJMP KEY_END
                      90                             
0067 1170             91     ALT_1:          ACALL SND_DT                            ; Posicionar segunda mitad del ASCII
0069 2C               92                             ADD A, KYSB                                     
006A C2D1             93                             CLR KYSC                                        
006C C2D5             94                             CLR ALT_EN                                      ; Resetear banderas
                              para siguiente ASCII
006E 80E3             95                             SJMP KEY_SHW                            ; Enviar ASCII
                      96     
0070 540F             97     SND_DT:         ANL A, #0FH                                     ; Valores de segunda tabla
0072 2410             98                             ADD A, #10H
0074 93               99                             MOVC A, @A + DPTR
0075 22              100                             RET
                     101     
                     102     ; Para interrupción externa 1 | Envío a bluetooth
0076 119F            103     SEND_ND:        ACALL DELAY
0078 119F            104                             ACALL DELAY
007A 119F            105                             ACALL DELAY
007C 7800            106                             MOV CHR_P, #0
007E 758DFD          107                             MOV TH1, #0FDH
0081 758BFD          108                             MOV TL1, #0FDH                          ; Estándar de 9600 baudios
0084 D28E            109                             SETB TR1
                     110     
0086 3099FD          111     SN_L0:          JNB TI, SN_L0
0089 C299            112                             CLR TI
008B 7430            113                             MOV A, #CHARR                           ; Inicio de arreglo
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 12:18:47 PAGE     3

008D 28              114                             ADD A, CHR_P                            ; Desplazamiento de posición
008E F9              115                             MOV CH_P_B, A                           ; Posición actual en arreglo
008F 8799            116                             MOV SBUF, @CH_P_B                       ; Cargar elemento de arreglo
0091 08              117                             INC CHR_P                                       ; Siguiente caracter
0092 09              118                             INC CH_P_B                                      ; Comprobación de d
                             elimitador
                     119                             
0093 B910F0          120                             CJNE CH_P_B, #10H, SN_L0        ; Verificar fin de arreglo
0096 C28E            121                             CLR TR1
0098 32              122                             RETI
                     123     
                     124     
                     125     
                     126     
                     127     
                     128     
                     129     
                     130     
                     131     
                     132     
                     133     
                     134     
                     135     
                     136     
                     137     
                     138     
                     139     
                     140     
                     141     
                     142     ; Para detección de ALT
0099 309702          143     ALT_IN:         JNB ALT, ALT_END
009C D2D5            144                             SETB ALT_EN                                     ; Entrar en modo ALT
009E 32              145     ALT_END:        RETI
                     146     
                     147     
                     148     ; Atraso genérico para dejar libres temporizadores
009F 7F30            149     DELAY:          MOV R7, #30H
00A1 7EFF            150     D_0:            MOV R6, #0FFH
00A3 DEFE            151     D_1:            DJNZ R6, D_1
00A5 DFFA            152                             DJNZ R7, D_0
00A7 22              153                             RET
                     154     
                     155     
                     156     ; Limpiar LCD
00A8 7401            157     LCD_CLR:        MOV A, #1H                                      ; 20H a cada posición | Lim
                             piar pantalla
00AA 11B0            158                             ACALL LCD_CMD
                     159     
                     160     
                     161     ; Posicionar en primera línea, primera posición de LCD
00AC 7480            162     LCD_FL:         MOV A, #80H                                     ; Cursor en primera línea, 
                             primera posición
00AE 11B0            163                             ACALL LCD_CMD
                     164     
                     165     
                     166     ; Enviar comandos a LCD
00B0 F5A0            167     LCD_CMD:        MOV LCD, A                                      ; Posicionar comando
00B2 C294            168                             CLR RS                                          ; Modo comando
00B4 D295            169                             SETB E
00B6 119F            170                             ACALL DELAY
00B8 C295            171                             CLR E                                           ; Enviar comando
00BA 119F            172                             ACALL DELAY
00BC 22              173                             RET
                     174     
                     175     
                     176     ; Enviar datos/caracteres a LCD
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 12:18:47 PAGE     4

00BD C0E0            177     LCD_CHR:        PUSH 0E0H                                       ; Guardar dato a desplegar
                     178     
00BF BB2006          179     LCD_ESL:        CJNE CCNT, #20H, LCD_EFL        ; Fin de segunda línea
00C2 11A8            180                             ACALL LCD_CLR                           ; Limpiar pantalla
00C4 11AC            181                             ACALL LCD_FL                            ; y resetear a primera posi
                             ción
00C6 7B00            182                             MOV CCNT, #0                            ; Resetear conteo de caract
                             eres
                     183                             
00C8 BB1004          184     LCD_EFL:        CJNE CCNT, #10H, LCD_SND        ; Fin de primera línea
00CB 74C0            185                             MOV A, #0C0H                            ; Cursor en segunda línea, 
                             primera posición
00CD 11B0            186                             ACALL LCD_CMD
                     187                             
00CF D0E0            188     LCD_SND:        POP 0E0H                                        ; Recuperar dato a desplegar
00D1 F5A0            189                             MOV LCD, A                                      ; Posicionar datos
00D3 D294            190                             SETB RS                                         ; Modo datos
00D5 D295            191                             SETB E
00D7 119F            192                             ACALL DELAY
00D9 C295            193                             CLR E                                           ; Enviar datos
00DB 119F            194                             ACALL DELAY
00DD 11E0            195                             ACALL ARR_SAVE                          ; Guardar caracter introduc
                             ido en arreglo
00DF 22              196                             RET
                     197     
                     198     
                     199     ; Almacenar en arreglo de caracteres
                     200     ; Delimitador de arreglo: 10H (por omisión en datasheet)
                     201     ; Inicio de arreglo: 30H
00E0 7430            202     ARR_SAVE:       MOV A, #CHARR                           ; Inicio de arreglo
00E2 2B              203                             ADD A, CCNT                                     ; Desplazamiento se
                             gún caracteres actuales
00E3 F8              204                             MOV CHR_P, A                            ; Posición actual de arreglo
00E4 A6A0            205                             MOV @CHR_P, LCD                         ; Guardar elemento en posic
                             ión actual
00E6 0B              206                             INC CCNT                                        ; Aumentar cantidad
                              de elementos almacenados actuales
00E7 08              207                             INC CHR_P                                       ; Siguiente posición
00E8 7610            208                             MOV @CHR_P, #10H                        ; Guardar delimitador
00EA 22              209                             RET
                     210     ; No es necesario resetear el arreglo gracios al delimitador
                     211     
                     212     
                     213     
00EB 119F            214     LCD_INIT:       ACALL DELAY
00ED 119F            215                             ACALL DELAY                                     ; Asegurar espera i
                             nicial
                     216                             
00EF 75F004          217                             MOV B, #4H
00F2 7438            218                             MOV A, #38H                                     ; Modo de 8 bits, 2
                              líneas (4 veces)
00F4 11B0            219     LI_0:           ACALL LCD_CMD
00F6 119F            220                             ACALL DELAY
00F8 D5F0F9          221                             DJNZ B, LI_0
                     222                             
00FB 11A8            223                             ACALL LCD_CLR                           ; Limpiar LCD
                     224                             
                     225                             ; Se incluye el siguiente comando por recomendación pero es omisible
                     226                             ; Incrementar posición, desplazamiento desactivado
00FD 7406            227                             MOV A, #6H
00FF 11B0            228                             ACALL LCD_CMD
                     229                             
0101 740F            230                             MOV A, #0FH                             ; Display, cursor y parpade
                             o encendidos
0103 11B0            231                             ACALL LCD_CMD
                     232                             
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 12:18:47 PAGE     5

0105 11AC            233                             ACALL LCD_FL                            ; Cursor inicial
                     234     
0107 753010          235                             MOV CHARR, #10H                         ; Delimitador en primer pos
                             ición de arreglo
                     236     
                     237     
010A 900690          238     MAIN:           MOV DPTR, #0A8H * 0AH           ; Posicionar apuntador en tabla de valores
010D C297            239                             CLR P1.7                                        ; Limpiar para dete
                             cción de ALT
                     240                             
010F 759842          241                             MOV SCON, #42H                          ; Habilitación de comunicac
                             ión serial
                     242                             
                     243                             ; MOV IE, #97H                          ; Interrupciones para seria
                             l, externas y T0
0112 75A887          244                             MOV IE, #87H                            ; Interrupciones externas y
                              T0 habilitadas
0115 758922          245                             MOV TMOD, #22H                          ; T0 y T1 en modo autorreca
                             rga
                     246                             
0118 758C00          247                             MOV TH0, #0
011B 758AFB          248                             MOV TL0, #0FBH                          ; Contar 500 nanosegundos
011E D28C            249                             SETB TR0
                     250                             
0120 80FE            251                             SJMP $                                          ; Loop principal
                     252                                     
                     253     ; ----------------------------------------------------------
                     254     
                     255     
                     256     
                     257     ; -------------- TABLA PARA DECODIFICAR TECLAS -------------
                     258     
0690                 259                             ORG 0690H
                     260                             
0690 31323341        261                             DB      '1', '2', '3', 'A'
0694 34353642        262                             DB      '4', '5', '6', 'B'
0698 37383943        263                             DB      '7', '8', '9', 'C'
069C 45304644        264                             DB      'E', '0', 'F', 'D'
                     265                             
06A0 0102030A        266                             DB      01H, 02H, 03H, 0AH
06A4 0405060B        267                             DB      04H, 05H, 06H, 0BH
06A8 0708090C        268                             DB      07H, 08H, 09H, 0CH
06AC 0E000F0D        269                             DB      0EH, 00H, 0FH, 0DH
                     270                                     
                     271                             
                     272     
                     273     
                     274     
                     275     
                     276     
                     277     
                     278     
                     279     
                     280     
                     281     
                     282     
                     283     
                     284     
                     285     
                     286     
                     287     
                     288     ; ----------------------------------------------------------
                     289     
                     290                             END
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 12:18:47 PAGE     6

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

ALT. . . . . . . .  B ADDR   0090H.7 A   
ALT_1. . . . . . .  C ADDR   0067H   A   
ALT_EN . . . . . .  N NUMB   00D5H   A   
ALT_END. . . . . .  C ADDR   009EH   A   
ALT_IN . . . . . .  C ADDR   0099H   A   
ARR_SAVE . . . . .  C ADDR   00E0H   A   
B. . . . . . . . .  D ADDR   00F0H   A   
CCNT . . . . . . .    REG    R3          
CHARR. . . . . . .  N NUMB   0030H   A   
CHR_P. . . . . . .    REG    R0          
CHR_S. . . . . . .    REG    R2          
CH_P_B . . . . . .    REG    R1          
DELAY. . . . . . .  C ADDR   009FH   A   
D_0. . . . . . . .  C ADDR   00A1H   A   
D_1. . . . . . . .  C ADDR   00A3H   A   
E. . . . . . . . .  B ADDR   0090H.5 A   
IE . . . . . . . .  D ADDR   00A8H   A   
KEYS . . . . . . .  D ADDR   0090H   A   
KEY_ALT. . . . . .  C ADDR   005CH   A   
KEY_END. . . . . .  C ADDR   0055H   A   
KEY_IN . . . . . .  C ADDR   0040H   A   
KEY_SGL. . . . . .  C ADDR   0050H   A   
KEY_SHW. . . . . .  C ADDR   0053H   A   
KYSB . . . . . . .    REG    R4          
KYSC . . . . . . .  N NUMB   00D1H   A   
LCD. . . . . . . .  D ADDR   00A0H   A   
LCD_CHR. . . . . .  C ADDR   00BDH   A   
LCD_CLR. . . . . .  C ADDR   00A8H   A   
LCD_CMD. . . . . .  C ADDR   00B0H   A   
LCD_EFL. . . . . .  C ADDR   00C8H   A   
LCD_ESL. . . . . .  C ADDR   00BFH   A   
LCD_FL . . . . . .  C ADDR   00ACH   A   
LCD_INIT . . . . .  C ADDR   00EBH   A   
LCD_SND. . . . . .  C ADDR   00CFH   A   
LI_0 . . . . . . .  C ADDR   00F4H   A   
MAIN . . . . . . .  C ADDR   010AH   A   
P1 . . . . . . . .  D ADDR   0090H   A   
P2 . . . . . . . .  D ADDR   00A0H   A   
RS . . . . . . . .  B ADDR   0090H.4 A   
SBUF . . . . . . .  D ADDR   0099H   A   
SCON . . . . . . .  D ADDR   0098H   A   
SEND_ND. . . . . .  C ADDR   0076H   A   
SND_DT . . . . . .  C ADDR   0070H   A   
SN_L0. . . . . . .  C ADDR   0086H   A   
TH0. . . . . . . .  D ADDR   008CH   A   
TH1. . . . . . . .  D ADDR   008DH   A   
TI . . . . . . . .  B ADDR   0098H.1 A   
TL0. . . . . . . .  D ADDR   008AH   A   
TL1. . . . . . . .  D ADDR   008BH   A   
TMOD . . . . . . .  D ADDR   0089H   A   
TR0. . . . . . . .  B ADDR   0088H.4 A   
TR1. . . . . . . .  B ADDR   0088H.6 A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
