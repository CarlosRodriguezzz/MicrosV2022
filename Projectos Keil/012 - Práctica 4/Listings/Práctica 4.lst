A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 19:14:03 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\Práctica 4.obj
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE Práctica 4.asm SET(SMALL) DEBUG PRINT(.\Listings\Práctica 4.lst) OBJECT
                      (.\Objects\Práctica 4.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     
                       2     
                       3     
                       4     
                       5     
                       6     
                       7     
                       8     
                       9     
                      10     
                      11     
                      12     
                      13     
                      14     
                      15     
                      16     
                      17     
                      18     
                      19     
                      20     
                      21     
                      22     
                      23                             
  0094                24                             RS         EQU P1.4                             ; Resister Select d
                             e LCD
  0095                25                             E          EQU P1.5                             ; Enable de LCD
  00A0                26                             LCD    EQU P2                           ; Bus para LCD
  0090                27                             KEYS   EQU P1                           ; Tecla codificada
  0097                28                             ALT    EQU P1.7                         ; Botón ALT
  00D5                29                             ALT_EN EQU 0D5H                         ; ALT activado
  00D1                30                             KYSC   EQU 0D1H                         ; Contador de teclas ingres
                             adas para ALT
  0030                31                             CHARR  EQU 030H                         ; Inicio de arreglo para ca
                             racteres a enviar
                      32                                     
  REG                 33                             CHR_P  EQU R0                           ; Posición de delimitador d
                             e arreglo
  REG                 34                             CHR_S  EQU R2                           ; Tamaño de arreglo
  REG                 35                             CCNT   EQU R3                           ; Contador de caracteres pa
                             ra display (max. 32 | 20H)
  REG                 36                             KYSB   EQU R4                           ; Almacenamiento de teclas 
                             presionadas para ALT
                      37     
                      38     
0000                  39                             ORG 0000H                                       
0000 01E2             40                             JMP LCD_INIT
                      41     
                      42     ; ------------------ INTERRUPCIÓN TECLADO ------------------
0003                  43                             ORG 0003H
0003 803B             44                             JMP KEY_IN
                      45     ; ----------------------------------------------------------
                      46     
                      47     
                      48     ; ------------------- INTERRUPCIÓN ALT ---------------------
000B                  49                             ORG 000BH       
000B 0193             50                             JMP ALT_IN
                      51     ; ----------------------------------------------------------
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 19:14:03 PAGE     2

                      52     
                      53     
                      54     ; ----------------- INTERRUPCIÓN BLUETOOTH -----------------
0013                  55                             ORG 0013H               
0013 8061             56                             JMP SEND_ND
                      57     ; ----------------------------------------------------------
                      58     
                      59     
                      60     ; -------------------- FLUJO PRINCIPAL ---------------------
0040                  61                             ORG 0040H
                      62     
                      63     ; Para interrupción externa 0 | Detección de tecla o ASCII
0040 1199             64     KEY_IN:         ACALL DELAY
0042 1199             65                             ACALL DELAY
0044 1199             66                             ACALL DELAY
0046 1199             67                             ACALL DELAY
0048 E590             68                             MOV A, KEYS
004A F4               69                             CPL A
                      70                             
004B 30D502           71                             JNB ALT_EN, KEY_SGL
004E 800C             72                             SJMP KEY_ALT            
                      73                             
0050 540F             74     KEY_SGL:        ANL A, #0FH
0052 93               75                             MOVC A, @A + DPTR                       ; Decodificar caracter
0053 11B7             76     KEY_SHW:        ACALL LCD_CHR                           ; Enviar caracter a LCD
0055 1199             77     KEY_END:        ACALL DELAY
0057 1199             78                             ACALL DELAY
0059 1199             79                             ACALL DELAY
005B 32               80                             RETI
                      81     
005C 20D108           82     KEY_ALT:        JB KYSC, ALT_1                          ;  Primer caracter
                      83                                                     
005F 1170             84                             ACALL SND_DT                            ; Posicionar primera mitad 
                             del ASCII
0061 C4               85                             SWAP A
0062 FC               86                             MOV KYSB, A
0063 D2D1             87                             SETB KYSC                                       ; Se indica la pres
                             encia del primer nibble
0065 80EE             88                             SJMP KEY_END
                      89                             
0067 1170             90     ALT_1:          ACALL SND_DT                            ; Posicionar segunda mitad del ASCII
0069 2C               91                             ADD A, KYSB                                     
006A C2D1             92                             CLR KYSC                                        
006C C2D5             93                             CLR ALT_EN                                      ; Resetear banderas
                              para siguiente ASCII
006E 80E3             94                             SJMP KEY_SHW                            ; Enviar ASCII
                      95     
0070 540F             96     SND_DT:         ANL A, #0FH                                     ; Valores de segunda tabla
0072 2410             97                             ADD A, #10H
0074 93               98                             MOVC A, @A + DPTR
0075 22               99                             RET
                     100     
                     101     
                     102     ; Para interrupción externa 1 | Envío a bluetooth
0076 1199            103     SEND_ND:        ACALL DELAY
0078 1199            104                             ACALL DELAY
007A 1199            105                             ACALL DELAY
                     106                             
                     107     
                     108     
                     109                             
007C 7830            110                             MOV CHR_P, #CHARR
007E EB              111                             MOV A, CCNT
007F 6017            112                             JZ ALT_END
0081 8699            113     SN_L0:          MOV SBUF, @CHR_P
0083 08              114                             INC CHR_P
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 19:14:03 PAGE     3

0084 3099FD          115                             JNB TI, $
0087 C299            116                             CLR TI
0089 D5E0F5          117                             DJNZ ACC, SN_L0
008C 1199            118                             ACALL DELAY
008E 1199            119                             ACALL DELAY
0090 1199            120                             ACALL DELAY
0092 32              121                             RETI
                     122     
                     123     ; Para detección de ALT
0093 309702          124     ALT_IN:         JNB ALT, ALT_END
0096 D2D5            125                             SETB ALT_EN                                     ; Entrar en modo ALT
0098 32              126     ALT_END:        RETI
                     127     
                     128     
                     129     ; Atraso genérico para dejar libres temporizadores
0099 7F30            130     DELAY:          MOV R7, #30H
009B 7EFF            131     D_0:            MOV R6, #0FFH
009D DEFE            132     D_1:            DJNZ R6, D_1
009F DFFA            133                             DJNZ R7, D_0
00A1 22              134                             RET
                     135     
                     136     
                     137     ; Limpiar LCD
00A2 7401            138     LCD_CLR:        MOV A, #1H                                      ; 20H a cada posición | Lim
                             piar pantalla
00A4 11AA            139                             ACALL LCD_CMD
                     140     
                     141     
                     142     ; Posicionar en primera línea, primera posición de LCD
00A6 7480            143     LCD_FL:         MOV A, #80H                                     ; Cursor en primera línea, 
                             primera posición
00A8 11AA            144                             ACALL LCD_CMD
                     145     
                     146     
                     147     ; Enviar comandos a LCD
00AA F5A0            148     LCD_CMD:        MOV LCD, A                                      ; Posicionar comando
00AC C294            149                             CLR RS                                          ; Modo comando
00AE D295            150                             SETB E
00B0 1199            151                             ACALL DELAY
00B2 C295            152                             CLR E                                           ; Enviar comando
00B4 1199            153                             ACALL DELAY
00B6 22              154                             RET
                     155     
                     156     
                     157     ; Enviar datos/caracteres a LCD
00B7 C0E0            158     LCD_CHR:        PUSH 0E0H                                       ; Guardar dato a desplegar
                     159     
00B9 BB2006          160     LCD_ESL:        CJNE CCNT, #20H, LCD_EFL        ; Fin de segunda línea
00BC 11A2            161                             ACALL LCD_CLR                           ; Limpiar pantalla
00BE 11A6            162                             ACALL LCD_FL                            ; y resetear a primera posi
                             ción
00C0 7B00            163                             MOV CCNT, #0                            ; Resetear conteo de caract
                             eres
                     164                             
00C2 BB1004          165     LCD_EFL:        CJNE CCNT, #10H, LCD_SND        ; Fin de primera línea
00C5 74C0            166                             MOV A, #0C0H                            ; Cursor en segunda línea, 
                             primera posición
00C7 11AA            167                             ACALL LCD_CMD
                     168                             
00C9 D0E0            169     LCD_SND:        POP 0E0H                                        ; Recuperar dato a desplegar
00CB F5A0            170                             MOV LCD, A                                      ; Posicionar datos
00CD D294            171                             SETB RS                                         ; Modo datos
00CF D295            172                             SETB E
00D1 1199            173                             ACALL DELAY
00D3 C295            174                             CLR E                                           ; Enviar datos
00D5 1199            175                             ACALL DELAY
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 19:14:03 PAGE     4

00D7 11DA            176                             ACALL ARR_SAVE                          ; Guardar caracter introduc
                             ido en arreglo
00D9 22              177                             RET
                     178     
                     179     
                     180     ; Almacenar en arreglo de caracteres
                     181     ; Inicio de arreglo: 30H
00DA 7430            182     ARR_SAVE:       MOV A, #CHARR                           ; Inicio de arreglo
00DC 2B              183                             ADD A, CCNT                                     ; Desplazamiento se
                             gún caracteres actuales
00DD F8              184                             MOV CHR_P, A                            ; Posición actual de arreglo
00DE A6A0            185                             MOV @CHR_P, LCD                         ; Guardar elemento en posic
                             ión actual
00E0 0B              186                             INC CCNT                                        ; Aumentar cantidad
                              de elementos almacenados actuales
00E1 22              187                             RET
                     188     
                     189     
                     190     
00E2 1199            191     LCD_INIT:       ACALL DELAY
00E4 1199            192                             ACALL DELAY                                     ; Asegurar espera i
                             nicial
                     193                             
00E6 75F004          194                             MOV B, #4H
00E9 7438            195                             MOV A, #38H                                     ; Modo de 8 bits, 2
                              líneas (4 veces)
00EB 11AA            196     LI_0:           ACALL LCD_CMD
00ED 1199            197                             ACALL DELAY
00EF D5F0F9          198                             DJNZ B, LI_0
                     199                             
00F2 11A2            200                             ACALL LCD_CLR                           ; Limpiar LCD
                     201                             
                     202                             ; Se incluye el siguiente comando por recomendación pero es omisible
                     203                             ; Incrementar posición, desplazamiento desactivado
00F4 7406            204                             MOV A, #6H
00F6 11AA            205                             ACALL LCD_CMD
                     206                             
00F8 740F            207                             MOV A, #0FH                             ; Display, cursor y parpade
                             o encendidos
00FA 11AA            208                             ACALL LCD_CMD
                     209                             
00FC 11A6            210                             ACALL LCD_FL                            ; Cursor inicial
                     211     
00FE 7B00            212                             MOV CCNT, #0                            ; Resetear contador de cara
                             cteres en matriz
                     213     
0100 900690          214     MAIN:           MOV DPTR, #0A8H * 0AH           ; Posicionar apuntador en tabla de valores
0103 C297            215                             CLR ALT                                         ; Limpiar para dete
                             cción de ALT
                     216                             
0105 759842          217                             MOV SCON, #42H                          ; Habilitación de comunicac
                             ión serial
                     218                             
0108 75A887          219                             MOV IE, #87H                            ; Interrupciones externas y
                              T0 habilitadas
010B 758922          220                             MOV TMOD, #22H                          ; T0 y T1 en modo autorreca
                             rga
                     221                             
010E 758C00          222                             MOV TH0, #0
0111 758AFB          223                             MOV TL0, #0FBH                          ; Contar 500 nanosegundos
0114 D28C            224                             SETB TR0
                     225                             
0116 758DFD          226                             MOV TH1, #0FDH
0119 758BFD          227                             MOV TL1, #0FDH                          ; Estándar de 9600 baudios
011C D28E            228                             SETB TR1
                     229                             
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 19:14:03 PAGE     5

011E C299            230                             CLR TI
                     231                             
0120 80FE            232                             SJMP $                                          ; Loop principal
                     233                                     
                     234     ; ----------------------------------------------------------
                     235     
                     236     
                     237     
                     238     ; -------------- TABLA PARA DECODIFICAR TECLAS -------------
                     239     
0690                 240                             ORG 0690H
                     241                             
0690 31323341        242                             DB      '1', '2', '3', 'A'
0694 34353642        243                             DB      '4', '5', '6', 'B'
0698 37383943        244                             DB      '7', '8', '9', 'C'
069C 45304644        245                             DB      'E', '0', 'F', 'D'
                     246                             
06A0 0102030A        247                             DB      01H, 02H, 03H, 0AH
06A4 0405060B        248                             DB      04H, 05H, 06H, 0BH
06A8 0708090C        249                             DB      07H, 08H, 09H, 0CH
06AC 0E000F0D        250                             DB      0EH, 00H, 0FH, 0DH
                     251     
                     252     ; ----------------------------------------------------------
                     253     
                     254                             END
A51 MACRO ASSEMBLER  PR_CTICA_4                                                           07/12/2022 19:14:03 PAGE     6

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

ACC. . . . . . . .  D ADDR   00E0H   A   
ALT. . . . . . . .  B ADDR   0090H.7 A   
ALT_1. . . . . . .  C ADDR   0067H   A   
ALT_EN . . . . . .  N NUMB   00D5H   A   
ALT_END. . . . . .  C ADDR   0098H   A   
ALT_IN . . . . . .  C ADDR   0093H   A   
ARR_SAVE . . . . .  C ADDR   00DAH   A   
B. . . . . . . . .  D ADDR   00F0H   A   
CCNT . . . . . . .    REG    R3          
CHARR. . . . . . .  N NUMB   0030H   A   
CHR_P. . . . . . .    REG    R0          
CHR_S. . . . . . .    REG    R2          
DELAY. . . . . . .  C ADDR   0099H   A   
D_0. . . . . . . .  C ADDR   009BH   A   
D_1. . . . . . . .  C ADDR   009DH   A   
E. . . . . . . . .  B ADDR   0090H.5 A   
IE . . . . . . . .  D ADDR   00A8H   A   
KEYS . . . . . . .  D ADDR   0090H   A   
KEY_ALT. . . . . .  C ADDR   005CH   A   
KEY_END. . . . . .  C ADDR   0055H   A   
KEY_IN . . . . . .  C ADDR   0040H   A   
KEY_SGL. . . . . .  C ADDR   0050H   A   
KEY_SHW. . . . . .  C ADDR   0053H   A   
KYSB . . . . . . .    REG    R4          
KYSC . . . . . . .  N NUMB   00D1H   A   
LCD. . . . . . . .  D ADDR   00A0H   A   
LCD_CHR. . . . . .  C ADDR   00B7H   A   
LCD_CLR. . . . . .  C ADDR   00A2H   A   
LCD_CMD. . . . . .  C ADDR   00AAH   A   
LCD_EFL. . . . . .  C ADDR   00C2H   A   
LCD_ESL. . . . . .  C ADDR   00B9H   A   
LCD_FL . . . . . .  C ADDR   00A6H   A   
LCD_INIT . . . . .  C ADDR   00E2H   A   
LCD_SND. . . . . .  C ADDR   00C9H   A   
LI_0 . . . . . . .  C ADDR   00EBH   A   
MAIN . . . . . . .  C ADDR   0100H   A   
P1 . . . . . . . .  D ADDR   0090H   A   
P2 . . . . . . . .  D ADDR   00A0H   A   
RS . . . . . . . .  B ADDR   0090H.4 A   
SBUF . . . . . . .  D ADDR   0099H   A   
SCON . . . . . . .  D ADDR   0098H   A   
SEND_ND. . . . . .  C ADDR   0076H   A   
SND_DT . . . . . .  C ADDR   0070H   A   
SN_L0. . . . . . .  C ADDR   0081H   A   
TH0. . . . . . . .  D ADDR   008CH   A   
TH1. . . . . . . .  D ADDR   008DH   A   
TI . . . . . . . .  B ADDR   0098H.1 A   
TL0. . . . . . . .  D ADDR   008AH   A   
TL1. . . . . . . .  D ADDR   008BH   A   
TMOD . . . . . . .  D ADDR   0089H   A   
TR0. . . . . . . .  B ADDR   0088H.4 A   
TR1. . . . . . . .  B ADDR   0088H.6 A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
